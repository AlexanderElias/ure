<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>T</title>
    </head>

    <body>

        <main></main>

        <script>

            const PatchAttributes = function (source, target) {
                const targetAttributeNames = target.hasAttributes() ? [...target.getAttributeNames()] : [];
                const sourceAttributeNames = source.hasAttributes() ? [...source.getAttributeNames()] : [];

                for (const name of targetAttributeNames) {
                    source.setAttribute(name, target.getAttribute(name));
                }

                for (const name of sourceAttributeNames) {
                    if (!targetAttributeNames.includes(name)) {
                        source.removeAttribute(name);
                    }
                }

            };

            const PatchAppend = function (parent, child) {
                parent.appendChild(child);
            };

            const PatchRemove = function (parent) {
                const child = parent.lastChild;
                if (child) parent.removeChild(child);
            };

            const PatchCommon = function (source, target) {

                if (source.nodeName !== target.nodeName) {
                    source.parentNode.replaceChild(target, source);
                }

                if (target.nodeName === '#text') {

                    if (source.nodeValue !== target.nodeValue) {
                        source.nodeValue = target.nodeValue;
                    }

                    return;
                }

                // if (virtualAttributes['html']) {
                //     PatchAttributes(node, target);
                //     return;
                // }

                const targetChildren = [...target.childNodes];
                const targetLength = targetChildren.length;
                const sourceChildren = [...source.childNodes];
                const sourceLength = sourceChildren.length;
                const commonLength = Math.min(sourceLength, targetLength);

                let index;

                for (index = 0; index < commonLength; index++) {
                    PatchCommon(sourceChildren[index], targetChildren[index]);
                }

                if (sourceLength > targetLength) {
                    for (index = targetLength; index < sourceLength; index++) {
                        PatchRemove(source);
                    }
                } else if (sourceLength < targetLength) {
                    for (index = sourceLength; index < targetLength; index++) {
                        PatchAppend(source, targetChildren[index]);
                    }
                }

                PatchAttributes(source, target);
            };

            const Patch = function (source, target) {
                let index;

                const targetChildren = [...target.childNodes];
                const targetLength = targetChildren.length;

                const sourceChildren = [...source.childNodes];
                const sourceLength = sourceChildren.length;

                const commonLength = Math.min(sourceLength, targetLength);

                for (index = 0; index < commonLength; index++) {
                    PatchCommon(sourceChildren[index], targetChildren[index]);
                }

                if (sourceLength > targetLength) {
                    for (index = targetLength; index < sourceLength; index++) {
                        PatchRemove(source);
                    }
                } else if (sourceLength < targetLength) {
                    for (index = sourceLength; index < targetLength; index++) {
                        PatchAppend(source, targetChildren[index]);
                    }
                }
            };

            const html = function (strings, ...values) {
                let data = '';
                const on = {};

                for (let index = 0; index < strings.length; index++) {
                    const part = strings[index];
                    const next = strings[index + 1];
                    const value = values[index];

                    if (part.endsWith('onclick="')) {
                        const id = crypto.randomUUID();
                        data += `${part.slice(0, -9)}data-x-onclick="${id}`;
                        on[id] = value;
                    } else if (value?.constructor === Array) {
                        data += part;
                        for (const v of value) {
                            data += v.data;
                            Object.assign(on, v.on);
                        }
                    } else {
                        data += part;
                        if (value !== undefined) data += `${value}`;
                    }

                }

                return { data, on };
            };

            const Render = function (root, context, component) {
                const componentInstance = component(html, context);

                const template = document.createElement('template');
                template.innerHTML = componentInstance.data;

                // const script = document.createElement('script');
                // script.textContent = `console.log(document.currentScript.parentElement)`;
                // template.content.appendChild(script);

                const onElements = template.content.querySelectorAll('[data-x-onclick]');
                for (const onElement of onElements) {
                    const index = onElement.getAttribute('data-x-onclick');
                    onElement.removeAttribute('data-x-onclick');
                    onElement.addEventListener('click', componentInstance.on[index]);
                }

                Patch(root, template.content);
            };

            const Mount = function (root, context, component) {
                const contextInstance = context(html);
                Render(root, contextInstance, component);
                return Render.bind(null, root, contextInstance, component);
            };

            /*
                app
            */

            const context = (html) => ({
                count: 0,
                title: 'The Count:',
                numbers: [1, 2, 3, 4, 5, 6, 7, 8, 9],
                click(e) {
                    console.log(this);
                    console.log(e, this.count++);
                    render();
                }
            });

            const component = (html, c) => html`
                <h1>${c.title} <i>${c.count}</i></h1>
                <button onclick="${(e) => c.click(e)}">Click</button>
                <div>
                    ${c.numbers.map(number => html`<span>${number}</span>`)}
                </div>
            `;

            const root = document.querySelector('main');

            const render = Mount(root, context, component);

            render();
        </script>

    </body>

</html>